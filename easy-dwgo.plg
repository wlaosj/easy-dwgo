<?xml version='1.0' standalone='yes'?>
<!DOCTYPE PLUGIN [
<!ENTITY name      "easy-dwgo">
<!ENTITY author    "éš”å£å°ç‹">
<!ENTITY version   "1.0.0">
<!ENTITY launch    "Settings/EasyDwgo.Main">
<!ENTITY sourceDir "/boot/config/plugins/easy-dwgo">
<!ENTITY pluginURL "https://raw.githubusercontent.com/wlaosj/easy-dwgo/refs/heads/main/easy-dwgo.plg">
<!ENTITY plgPATH   "/boot/config/plugins/&name;">
<!ENTITY plgNAME   "&name;-&version;-x86_64">
<!ENTITY emhttp    "/usr/local/emhttp/plugins/&name;">
]>

<PLUGIN name="&name;" author="&author;" version="&version;" launch="&launch;" pluginURL="&pluginURL;" min="6.12.0" support="https://t.me/+7jcTMePlNVwwZjg1" icon="code">

<CHANGES>
1.0.0  åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- æ”¯æŒGoç¯å¢ƒè‡ªåŠ¨å®‰è£…å’Œç®¡ç†
- æ”¯æŒå¤šç‰ˆæœ¬Goç¯å¢ƒåˆ‡æ¢ï¼ˆ1.20.x, 1.21.x, 1.22.xï¼‰
- é›†æˆWebç®¡ç†ç•Œé¢
- æ”¯æŒGoåŒ…ç®¡ç†å’Œé¡¹ç›®åˆ›å»º
- æ”¯æŒå¼€æœºè‡ªå¯åŠ¨
- æ”¯æŒä»ªè¡¨æ¿çŠ¶æ€æ˜¾ç¤º
- æ”¯æŒç¯å¢ƒå˜é‡è‡ªåŠ¨é…ç½®
</CHANGES>

<!-- pre-install: ensure clean run dir -->
<FILE Run="/bin/bash">
<INLINE>
set -e
rm -rf /usr/local/emhttp/plugins/easy-dwgo
mkdir -p /usr/local/emhttp/plugins/easy-dwgo/scripts
mkdir -p /boot/config/plugins/easy-dwgo
</INLINE>
</FILE>

<!-- copy files from source directory -->
<FILE Run="/bin/bash">
<INLINE><![CDATA[
set -e
# ä»æºç›®å½•å¤åˆ¶æ‰€æœ‰æ–‡ä»¶
echo "æ­£åœ¨åˆ›å»ºGoç¯å¢ƒæ’ä»¶ç›®å½•ç»“æ„..."

# åœæ­¢æ­£åœ¨è¿è¡Œçš„Goç›¸å…³æœåŠ¡
echo "æ­£åœ¨æ£€æŸ¥Goç¯å¢ƒ..."
if pgrep -f "go run" >/dev/null 2>&1; then
  echo "  âœ“ æ£€æµ‹åˆ°Goè¿›ç¨‹ï¼Œå°†åœ¨å®‰è£…å®Œæˆåé‡å¯"
fi

# åˆ›å»ºGoç¯å¢ƒç®¡ç†è„šæœ¬
echo "  - æ­£åœ¨åˆ›å»ºGoç¯å¢ƒç®¡ç†è„šæœ¬..."
cat > "/usr/local/emhttp/plugins/easy-dwgo/scripts/go_manager.sh" << 'EOF'
#!/bin/bash
# Goç¯å¢ƒç®¡ç†å™¨

GOPATH="/tmp/go"
GOROOT="/usr/local/go"
GO_VERSION_FILE="/boot/config/plugins/easy-dwgo/version.conf"

# ç»Ÿä¸€çš„Goç¯å¢ƒæ¢å¤å‡½æ•°
restore_go_environment() {
    # æ£€æŸ¥GOROOTç›®å½•æ˜¯å¦å­˜åœ¨
    if [ ! -d "$GOROOT" ] || [ ! -f "$GOROOT/bin/go" ]; then
        echo "æ£€æµ‹åˆ°Go SDKç¼ºå¤±ï¼Œæ­£åœ¨æ¢å¤..." >> /var/log/easy-dwgo.log 2>&1
        
        # æ£€æŸ¥Uç›˜æ˜¯å¦æœ‰Go SDKå¤‡ä»½
        GO_SDK_BACKUP="/boot/config/plugins/easy-dwgo/go-sdk.tar.gz"
        if [ -f "$GO_SDK_BACKUP" ]; then
            echo "ä»Uç›˜æ¢å¤Go SDK..." >> /var/log/easy-dwgo.log 2>&1
            mkdir -p /usr/local
            tar -xzf "$GO_SDK_BACKUP" -C /usr/local/
            chmod -R 755 /usr/local/go
            echo "Go SDKæ¢å¤å®Œæˆ" >> /var/log/easy-dwgo.log 2>&1
        else
            echo "é”™è¯¯ï¼šGo SDKå¤‡ä»½ä¸å­˜åœ¨ï¼Œéœ€è¦é‡æ–°å®‰è£…" >> /var/log/easy-dwgo.log 2>&1
            return 1
        fi
    fi
    
    # åˆ›å»ºç¬¦å·é“¾æ¥
    create_go_symlinks
    
    # è®¾ç½®ç¯å¢ƒå˜é‡
    setup_go_environment
    
    # ç¡®ä¿GOPATHç›®å½•å­˜åœ¨ï¼Œè®¾ç½®æ­£ç¡®æƒé™
    mkdir -p "$GOPATH"/{bin,src,pkg}
    chmod -R 755 "$GOPATH"
    chown -R nobody:users "$GOPATH"
    echo "GOPATHç›®å½•å·²åˆ›å»º: $GOPATH" >> /var/log/easy-dwgo.log 2>&1
    
    return 0
}

# åˆ›å»ºGoç¬¦å·é“¾æ¥
create_go_symlinks() {
    mkdir -p /usr/local/bin
    ln -sf /usr/local/go/bin/go /usr/local/bin/go
    ln -sf /usr/local/go/bin/gofmt /usr/local/bin/gofmt
    echo "Goç¬¦å·é“¾æ¥åˆ›å»ºå®Œæˆ" >> /var/log/easy-dwgo.log 2>&1
}

# è®¾ç½®Goç¯å¢ƒå˜é‡
setup_go_environment() {
    # åˆ›å»ºGOPATHç›®å½•ï¼Œè®¾ç½®æ­£ç¡®æƒé™
    mkdir -p "$GOPATH"/{bin,src,pkg}
    chmod -R 755 "$GOPATH"
    chown -R nobody:users "$GOPATH"
    
    # è®¾ç½®ç¯å¢ƒå˜é‡åˆ°ç³»ç»Ÿ
    cat > /etc/profile.d/go.sh << 'GOEOF'
export GOROOT="/usr/local/go"
export GOPATH="/tmp/go"
export PATH="$PATH:$GOROOT/bin:$GOPATH/bin"
GOEOF
    
    # ä½¿ç¯å¢ƒå˜é‡ç«‹å³ç”Ÿæ•ˆ
    source /etc/profile.d/go.sh
    echo "Goç¯å¢ƒå˜é‡è®¾ç½®å®Œæˆ" >> /var/log/easy-dwgo.log 2>&1
}

# è·å–Goç‰ˆæœ¬
get_go_version() {
    if [ -f "$GOROOT/bin/go" ]; then
        "$GOROOT/bin/go" version 2>/dev/null | head -n1 || echo "unknown"
    else
        echo "not installed"
    fi
}

# æ£€æŸ¥Goç¯å¢ƒçŠ¶æ€
check_go_status() {
    if [ -d "$GOROOT" ] && [ -f "$GOROOT/bin/go" ] && "$GOROOT/bin/go" version >/dev/null 2>&1; then
        echo "installed"
    else
        echo "not installed"
    fi
}

# ä¸»å‡½æ•°
main() {
    case "$1" in
        "check")
            check_go_status
            ;;
        "restore")
            restore_go_environment
            ;;
        "version")
            get_go_version
            ;;
        "setup")
            setup_go_environment
            ;;
        "symlinks")
            create_go_symlinks
            ;;
        *)
            echo "Usage: $0 {check|restore|version|setup|symlinks}"
            exit 1
            ;;
    esac
}

main "$@"
EOF

chmod +x "/usr/local/emhttp/plugins/easy-dwgo/scripts/go_manager.sh"
echo "  âœ“ Goç¯å¢ƒç®¡ç†è„šæœ¬å·²åˆ›å»º"

# åˆ›å»ºGoç‰ˆæœ¬ä¸‹è½½è„šæœ¬
echo "  - æ­£åœ¨åˆ›å»ºGoç‰ˆæœ¬ä¸‹è½½è„šæœ¬..."
cat > "/usr/local/emhttp/plugins/easy-dwgo/scripts/download_go.sh" << 'EOF'
#!/bin/bash
set -e

PROGRESS=0
if [ "$1" = "--progress" ]; then PROGRESS=1; fi

VERSION="$2"
if [ -z "$VERSION" ]; then
    VERSION="1.21.5"  # é»˜è®¤ç‰ˆæœ¬
fi

DOWNLOAD_DIR="/tmp/go-download"
TMP_GO="/tmp/go-latest"
STATUS_DIR="/var/tmp/easy-dwgo-progress"
STATUS_FILE="$STATUS_DIR/go.status"
mkdir -p "$STATUS_DIR"

write_status(){
  echo "$1"
  if [ "$PROGRESS" = "1" ]; then echo "$1" > "$STATUS_FILE"; fi
}

trap 'write_status "error: unexpected failure"' ERR

mkdir -p "$DOWNLOAD_DIR"
write_status "10%: å‡†å¤‡ä¸‹è½½Go $VERSION..."

# æ„å»ºä¸‹è½½URL
GO_URL="https://golang.org/dl/go${VERSION}.linux-amd64.tar.gz"

if wget -q "$GO_URL" -O "$DOWNLOAD_DIR/go${VERSION}.linux-amd64.tar.gz"; then
  write_status "60%: ä¸‹è½½å®Œæˆï¼Œæ­£åœ¨è§£å‹..."
else
  write_status "error: ä¸‹è½½å¤±è´¥"; exit 1
fi

if tar -C /tmp -xzf "$DOWNLOAD_DIR/go${VERSION}.linux-amd64.tar.gz" 2>/dev/null; then
  write_status "90%: æ­£åœ¨å®‰è£…Go..."
else
  write_status "error: è§£å‹å¤±è´¥"; rm -f "$TMP_GO"; exit 1
fi

# å®‰è£…Go - å®Œæ•´SDKå®‰è£…
mkdir -p /usr/local
mkdir -p /boot/config/plugins/easy-dwgo

# å®‰è£…å®Œæ•´çš„Go SDKåˆ° /usr/local/go
if [ -d "/tmp/go" ]; then
    # å¦‚æœå·²å­˜åœ¨ï¼Œå…ˆåˆ é™¤
    rm -rf /usr/local/go
    # ç§»åŠ¨æ•´ä¸ªGo SDK
    mv /tmp/go /usr/local/go
    chmod -R 755 /usr/local/go
fi

# åˆ›å»ºç¬¦å·é“¾æ¥åˆ°ç³»ç»ŸPATH
mkdir -p /usr/local/bin
ln -sf /usr/local/go/bin/go /usr/local/bin/go
ln -sf /usr/local/go/bin/gofmt /usr/local/bin/gofmt

# å¤‡ä»½å®Œæ•´çš„Go SDKåˆ°Uç›˜ï¼ˆç”¨äºé‡å¯åæ¢å¤ï¼‰
echo "æ­£åœ¨å¤‡ä»½Go SDKåˆ°Uç›˜..." >> /var/log/easy-dwgo.log 2>&1
tar -czf /boot/config/plugins/easy-dwgo/go-sdk.tar.gz -C /usr/local go
echo "Go SDKå¤‡ä»½å®Œæˆ" >> /var/log/easy-dwgo.log 2>&1

# ä¿å­˜ç‰ˆæœ¬ä¿¡æ¯
echo "$VERSION" > /boot/config/plugins/easy-dwgo/version.conf

# è®¾ç½®ç¯å¢ƒå˜é‡
mkdir -p /tmp/go/{bin,src,pkg}
chmod -R 755 /tmp/go
chown -R nobody:users /tmp/go
cat > /etc/profile.d/go.sh << 'GOEOF'
export GOROOT="/usr/local/go"
export GOPATH="/tmp/go"
export PATH="$PATH:$GOROOT/bin:$GOPATH/bin"
GOEOF

rm -rf "$DOWNLOAD_DIR"
write_status "100%: Go $VERSION å®‰è£…å®Œæˆï¼ˆå·²ä¿å­˜åˆ°Uç›˜å’Œå†…å­˜ï¼‰"
( sleep 1; rm -f "$STATUS_FILE" ) >/dev/null 2>&1 &
EOF

chmod +x "/usr/local/emhttp/plugins/easy-dwgo/scripts/download_go.sh"
echo "  âœ“ Goç‰ˆæœ¬ä¸‹è½½è„šæœ¬å·²åˆ›å»º"

# è·³è¿‡ä»ªè¡¨æ¿JavaScriptæ–‡ä»¶åˆ›å»º
echo "  âœ“ è·³è¿‡ä»ªè¡¨æ¿æ¨¡å—ï¼ˆå·²ç¦ç”¨ï¼‰"

# å®‰è£…é˜¶æ®µå®Œæˆ
echo "âœ“ Goç¯å¢ƒæ’ä»¶åŸºç¡€æ–‡ä»¶éƒ¨ç½²å®Œæˆ"
]]></INLINE>
</FILE>

<!-- WebUI index -->
<FILE Name="/usr/local/emhttp/plugins/easy-dwgo/index.php">
<INLINE><![CDATA[
<?php
$baseRun = '/usr/local/emhttp/plugins/easy-dwgo';
$scripts = $baseRun . '/scripts';
$logFile = '/var/log/easy-dwgo.log';
$confDir = '/boot/config/plugins/easy-dwgo';

// è¿›åº¦æ–‡ä»¶ç›®å½•
$progressDir = '/var/tmp/easy-dwgo-progress';
@mkdir($progressDir, 0777, true);

$cmd = isset($_POST['cmd']) ? $_POST['cmd'] : (isset($_GET['cmd']) ? $_GET['cmd'] : '');
$msg = '';

// å¤„ç†å‘½ä»¤
if ($cmd === 'get_progress') {
  $file = $progressDir . '/go.status';
  header('Content-Type: text/plain; charset=utf-8');
  if (is_file($file)) {
    echo @file_get_contents($file);
  }
  exit;
}

if ($cmd === 'start_download') {
  $version = $_GET['version'] ?? $_POST['version'] ?? '1.21.5';
  @unlink($progressDir . '/go.status');
  $out = shell_exec("nohup bash $scripts/download_go.sh --progress '$version' >$progressDir/go.log 2>&1 & echo $!");
  $msg = 'Goä¸‹è½½ä»»åŠ¡å·²å¯åŠ¨ PID: ' . htmlspecialchars(trim($out));
  
  if ((isset($_GET['ajax']) && $_GET['ajax'] === '1') || (isset($_POST['ajax']) && $_POST['ajax'] === '1')) {
    header('Content-Type: text/plain; charset=utf-8');
    echo $msg;
    exit;
  }
}

// æ¢å¤ç¯å¢ƒå’Œè®¾ç½®ç¯å¢ƒåŠŸèƒ½å·²é›†æˆåˆ°è‡ªåŠ¨æ¢å¤æœºåˆ¶ä¸­

// é¡¹ç›®ç®¡ç†åŠŸèƒ½å·²ç§»é™¤ - ç”¨æˆ·å¯ç›´æ¥ä½¿ç”¨ç»ˆç«¯æˆ–IDEåˆ›å»ºGoé¡¹ç›®

// è·å–çŠ¶æ€ä¿¡æ¯
$status = shell_exec("bash $scripts/go_manager.sh check 2>&1");
$version = shell_exec("bash $scripts/go_manager.sh version 2>&1");

// æ£€æŸ¥å®‰è£…çŠ¶æ€
$installStatus = '';
$goSdkExists = is_dir('/usr/local/go') && file_exists('/usr/local/go/bin/go');
$gopathExists = is_dir('/tmp/go');

if (!$goSdkExists) {
  $installStatus = '<div class="error">âŒ Goç¯å¢ƒæœªå®‰è£…ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹"ä¸‹è½½/å®‰è£…Go"æŒ‰é’®</div>';
} elseif (!$gopathExists) {
  $installStatus = '<div class="warning">âš ï¸ GOPATHç›®å½•ä¸å­˜åœ¨ï¼Œå°†åœ¨ä¸‹æ¬¡å®‰è£…Goæ—¶è‡ªåŠ¨åˆ›å»º</div>';
}

// è·å–å¯ç”¨ç‰ˆæœ¬åˆ—è¡¨
$availableVersions = [
    '1.20.14' => 'Go 1.20.14 (ç¨³å®šç‰ˆ)',
    '1.21.5' => 'Go 1.21.5 (æ¨èç‰ˆ)',
    '1.22.0' => 'Go 1.22.0 (æœ€æ–°ç‰ˆ)'
];

// è·å–å½“å‰ç‰ˆæœ¬
$currentVersion = '';
if (is_file('/boot/config/plugins/easy-dwgo/version.conf')) {
    $currentVersion = trim(@file_get_contents('/boot/config/plugins/easy-dwgo/version.conf'));
}
?>
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Easy-Dwgo</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;margin:16px;color:#222}
.card{border:1px solid #ddd;border-radius:8px;padding:16px;margin-bottom:16px}
pre{background:#f7f7f7;border:1px solid #eee;border-radius:6px;padding:10px;max-height:360px;overflow:auto}
button{padding:8px 14px;margin-right:8px;cursor:pointer}
input[type=text], select{padding:6px;margin:4px;border:1px solid #ddd;border-radius:4px}
.warning{background:#fff3cd;border:1px solid #ffeaa7;color:#856404;padding:12px;border-radius:6px;margin-bottom:16px}
.error{color:#dc3545;margin:4px 0;font-size:14px}
.success{color:#28a745;margin:4px 0;font-size:14px}
.info{color:#17a2b8;margin:4px 0;font-size:14px}
</style>
<script>
function executeAction(action, param = '') {
  var url = new URL(window.location);
  url.searchParams.set('cmd', action);
  if (param) {
    url.searchParams.set('version', param);
  }
  window.location.href = url.toString();
}

function startDownload(version, btn) {
  try {
    if (btn) {
      btn.dataset.oldText = btn.innerText;
      btn.disabled = true;
      btn.innerText = 'ä¸‹è½½ä¸­...';
    }
    var box = document.getElementById('download-msg');
    if (box) box.innerText = 'å·²å‘èµ·ä¸‹è½½ä»»åŠ¡ï¼Œæ­£åœ¨å‡†å¤‡...';
  } catch (e) {}
  var xhr = new XMLHttpRequest();
  xhr.open('GET', '/plugins/easy-dwgo/api.php?cmd=start_download&version=' + encodeURIComponent(version));
  xhr.onload = function(){
    if (xhr.status === 200) {
      var box = document.getElementById('download-msg');
      if (box) box.innerText = (xhr.responseText || '').trim() || 'ä»»åŠ¡å·²å¯åŠ¨';
    }
    try { if (btn) { btn.disabled = false; btn.innerText = btn.dataset.oldText || btn.innerText; } } catch (e) {}
  };
  xhr.onerror = function(){ try { if (btn) { btn.disabled = false; btn.innerText = btn.dataset.oldText || btn.innerText; } } catch(e){} };
  xhr.send();
}

function pollProgress(elId) {
  function tick(){
    var xhr = new XMLHttpRequest();
    xhr.open('GET', '/plugins/easy-dwgo/api.php?cmd=get_progress');
    xhr.onload = function(){
      if (xhr.status === 200) {
        var box = document.getElementById(elId);
        var txt = xhr.responseText || '';
        if (txt.trim()) {
          box.innerText = txt;
        } else {
          // è¿›åº¦æ–‡ä»¶å·²è¢«æ¸…ç†ï¼Œè§†ä¸ºå®Œæˆ
          if (box.innerText && box.innerText.trim() !== '') {
            box.innerText = 'âœ… ä¸‹è½½å®Œæˆ';
            setTimeout(function(){ box.innerText=''; }, 3000);
          }
        }
      }
    };
    xhr.send();
  }
  tick();
  return setInterval(tick, 2000);
}

// é¡¹ç›®ç®¡ç†åŠŸèƒ½å·²ç§»é™¤ - ç”¨æˆ·å¯ç›´æ¥ä½¿ç”¨ç»ˆç«¯æˆ–IDEåˆ›å»ºGoé¡¹ç›®
</script>
</head>
<body>
<h2>Goç¯å¢ƒç®¡ç†</h2>
<?php if ($installStatus) { echo $installStatus; } ?>

<div class="card">
  <div>
    <b>è¿è¡ŒçŠ¶æ€ï¼š</b>
    <?php
      $statusText = trim($status ?? 'unknown');
      if ($statusText === 'installed') {
        echo '<span style="color:#28a745;font-weight:bold;">ğŸŸ¢ å·²å®‰è£…</span>';
      } else {
        echo '<span style="color:#dc3545;font-weight:bold;">ğŸ”´ æœªå®‰è£…</span>';
      }
    ?>
  </div>

  <div style="margin-top:8px">
    <b>Goç¯å¢ƒï¼š</b>
    <?php if ($goSdkExists): ?>
      <span style="color:#28a745">å·²å®‰è£…</span> | ç‰ˆæœ¬ï¼š<?= htmlspecialchars(trim($version ?? 'unknown')) ?>
    <?php else: ?>
      <span style="color:#dc3545">æœªå®‰è£…</span> | <span style="color:#6c757d;font-size:12px;">ï¼ˆé‡å¯åè‡ªåŠ¨æ¢å¤ï¼‰</span>
    <?php endif; ?>
  </div>

  <div style="margin-top:6px">
    <b>GOPATHï¼š</b>
    <?php if ($gopathExists): ?>
      <span style="color:#28a745">å·²é…ç½®</span> | è·¯å¾„ï¼š/tmp/go <span style="color:#6c757d;font-size:12px;">ï¼ˆå†…å­˜è·¯å¾„ï¼Œé‡å¯åéœ€é‡æ–°å®‰è£…å·¥å…·ï¼‰</span>
    <?php else: ?>
      <span style="color:#ffc107">æœªé…ç½®</span> | <span style="color:#6c757d;font-size:12px;">ï¼ˆå®‰è£…Goæ—¶è‡ªåŠ¨é…ç½®ï¼‰</span>
    <?php endif; ?>
  </div>

  <div style="margin-top:8px;padding:8px;background:#e7f3ff;border:1px solid #b3d9ff;border-radius:4px;">
    <span style="color:#0066cc;font-size:12px;">
      ğŸ’¡ <strong>è‡ªåŠ¨æ¢å¤å·²å¯ç”¨</strong>ï¼šé‡å¯åGo SDKä¼šè‡ªåŠ¨æ¢å¤ï¼ŒGOPATHä½¿ç”¨å†…å­˜è·¯å¾„ï¼ˆé‡å¯åéœ€é‡æ–°å®‰è£…å·¥å…·ï¼‰
    </span>
  </div>
</div>

<div class="card">
  <h3>Goç‰ˆæœ¬ç®¡ç†</h3>
  <div>
    <b>å½“å‰ç‰ˆæœ¬ï¼š</b><?= htmlspecialchars($currentVersion ?: 'æœªå®‰è£…') ?>
  </div>
  
  <div style="margin-top:10px">
    <b>å®‰è£…æ–°ç‰ˆæœ¬ï¼š</b>
    <select id="version_select">
      <?php foreach ($availableVersions as $ver => $desc): ?>
        <option value="<?= $ver ?>" <?= ($ver === $currentVersion ? 'selected' : '') ?>><?= htmlspecialchars($desc) ?></option>
      <?php endforeach; ?>
    </select>
    <button onclick="startDownload(document.getElementById('version_select').value, this)">ä¸‹è½½/å®‰è£…</button>
  </div>
  
  <div id="progress-go" style="font-size:12px;color:#6c757d;margin-top:4px"></div>
</div>

<!-- é¡¹ç›®ç®¡ç†åŠŸèƒ½å·²ç§»é™¤ - ç”¨æˆ·å¯ç›´æ¥ä½¿ç”¨ç»ˆç«¯æˆ–IDEåˆ›å»ºGoé¡¹ç›® -->

<div class="card">
  <h3>ç¯å¢ƒä¿¡æ¯</h3>
  <div>
    <b>GOROOTï¼š</b>/usr/local/go<br>
    <b>GOPATHï¼š</b>/tmp/go <span style="color:#6c757d;font-size:12px;">ï¼ˆå†…å­˜è·¯å¾„ï¼‰</span><br>
    <b>Goç‰ˆæœ¬ï¼š</b><?= htmlspecialchars(trim($version ?? 'unknown')) ?><br>
    <b>å®‰è£…çŠ¶æ€ï¼š</b><?= htmlspecialchars(trim($status ?? 'unknown')) ?>
  </div>
</div>

<div id="download-msg" style="font-size:12px;color:#6c757d;margin-top:6px"></div>

<script>
// é¡µé¢åŠ è½½åå¼€å§‹è½®è¯¢è¿›åº¦
pollProgress('progress-go');
</script>
</body>
</html>
]]></INLINE>
</FILE>

<FILE Name="/usr/local/emhttp/plugins/easy-dwgo/api.php">
<INLINE><![CDATA[
<?php
// è½»é‡ APIï¼šçº¯æ–‡æœ¬è¿”å›ï¼Œé¿å… emhttp å¤–å±‚ HTML åŒ…è£…
header('Content-Type: text/plain; charset=utf-8');

$baseRun = '/usr/local/emhttp/plugins/easy-dwgo';
$scripts = $baseRun . '/scripts';
$progressDir = '/var/tmp/easy-dwgo-progress';
@mkdir($progressDir, 0777, true);

$cmd = $_GET['cmd'] ?? $_POST['cmd'] ?? '';

if ($cmd === 'get_progress') {
  $file = $progressDir . '/go.status';
  if (is_file($file)) { 
    echo @file_get_contents($file); 
  }
  exit;
}

if ($cmd === 'start_download') {
  $version = $_GET['version'] ?? $_POST['version'] ?? '1.21.5';
  @unlink($progressDir . '/go.status');
  $out = shell_exec("nohup bash $scripts/download_go.sh --progress '$version' >$progressDir/go.log 2>&1 & echo $!");
  echo 'Goä¸‹è½½ä»»åŠ¡å·²å¯åŠ¨ PID: ' . trim($out);
  exit;
}

// ä»ªè¡¨æ¿APIå·²ç§»é™¤

// æ¢å¤ç¯å¢ƒå’Œè®¾ç½®ç¯å¢ƒåŠŸèƒ½å·²é›†æˆåˆ°è‡ªåŠ¨æ¢å¤æœºåˆ¶ä¸­

echo 'unknown command';
?>
]]></INLINE>
</FILE>

<!-- Main page content -->
<FILE Name="/usr/local/emhttp/plugins/easy-dwgo/EasyDwgo.Main.page">
<INLINE><![CDATA[
Menu="Utilities"
Type="xmenu"
Title="Easy-Dwgo"
Icon="code"
Tabs="false"
---
<?php
include '/usr/local/emhttp/plugins/easy-dwgo/index.php';
?>
]]></INLINE>
</FILE>

<!-- Dashboard page content removed -->

<!-- post-install: setup menu entry -->
<FILE Run="/bin/bash">
<INLINE>
set -e
echo "Goç¯å¢ƒæ’ä»¶å®‰è£…å®Œæˆã€‚æŒä¹…åŒ–è·¯å¾„: /boot/config/plugins/easy-dwgo"

# è®¾ç½®å¼€æœºè‡ªåŠ¨æ¢å¤Goç¯å¢ƒ
echo "  - è®¾ç½®å¼€æœºè‡ªåŠ¨æ¢å¤æœºåˆ¶..."

# å®‰å…¨çš„goæ–‡ä»¶ä¿®æ”¹æ–¹å¼ - ä½¿ç”¨æ ‡è®°å—
goPath="/boot/config/go"
begin="# BEGIN easy-dwgo (do not edit)"
end="# END easy-dwgo"

# è¯»å–ç°æœ‰goæ–‡ä»¶
go=$(cat "$goPath" 2>/dev/null || echo "")

# æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ’ä»¶æ ‡è®°å—
if echo "$go" | grep -q "$begin" &amp;&amp; echo "$go" | grep -q "$end"; then
    # æ›¿æ¢ç°æœ‰æ ‡è®°å—
    temp_file=$(mktemp)
    cat &gt; "$temp_file" &lt;&lt; 'EOF'
# BEGIN easy-dwgo (do not edit)
# Goç¯å¢ƒè‡ªåŠ¨æ¢å¤
if [ -f "/boot/config/plugins/easy-dwgo/go-sdk.tar.gz" ] &amp;&amp; [ ! -d "/usr/local/go" ]; then
    echo "[Goç¯å¢ƒ] æ£€æµ‹åˆ°é‡å¯ï¼Œæ­£åœ¨è‡ªåŠ¨æ¢å¤Goç¯å¢ƒ..."
    /usr/local/emhttp/plugins/easy-dwgo/scripts/go_manager.sh restore &gt;/dev/null 2&gt;&amp;1 &amp;
fi
# END easy-dwgo
EOF
    # ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼æ›¿æ¢
    awk -v begin="$begin" -v end="$end" -v replacement="$(cat "$temp_file")" '
    /^# BEGIN easy-dwgo \(do not edit\)$/ { in_block=1; print replacement; next }
    /^# END easy-dwgo$/ { in_block=0; next }
    !in_block { print }
    ' "$goPath" &gt; "$goPath.tmp" &amp;&amp; mv "$goPath.tmp" "$goPath"
    rm -f "$temp_file"
else
    # è¿½åŠ æ–°çš„æ ‡è®°å—
    if [ -n "$go" ] &amp;&amp; [ "${go: -1}" != "\n" ]; then
        echo "" >> "$goPath"
    fi
    cat &gt;&gt; /boot/config/go &lt;&lt; 'GOEOF'
# BEGIN easy-dwgo (do not edit)
# Goç¯å¢ƒè‡ªåŠ¨æ¢å¤
if [ -f "/boot/config/plugins/easy-dwgo/go-sdk.tar.gz" ] &amp;&amp; [ ! -d "/usr/local/go" ]; then
    echo "[Goç¯å¢ƒ] æ£€æµ‹åˆ°é‡å¯ï¼Œæ­£åœ¨è‡ªåŠ¨æ¢å¤Goç¯å¢ƒ..."
    /usr/local/emhttp/plugins/easy-dwgo/scripts/go_manager.sh restore &gt;/dev/null 2&gt;&amp;1 &amp;
fi
# END easy-dwgo
GOEOF
fi

echo "  âœ“ å¼€æœºè‡ªåŠ¨æ¢å¤å·²è®¾ç½®ï¼ˆå®‰å…¨æ¨¡å¼ï¼‰"
</INLINE>
</FILE>

<!-- remove -->
<FILE Run="/bin/bash" Method="remove">
<INLINE><![CDATA[
set -e
echo "æ­£åœ¨å¸è½½ Easy-Dwgo æ’ä»¶..."

# æ¸…ç†Goç¯å¢ƒ
echo "  - æ¸…ç†Goç¯å¢ƒ..."
rm -f /usr/local/bin/go
rm -f /usr/local/bin/gofmt
rm -rf /usr/local/go
rm -f /boot/config/plugins/easy-dwgo/go-sdk.tar.gz
rm -f /boot/config/plugins/easy-dwgo/version.conf

# æ¸…ç†ç¯å¢ƒå˜é‡
echo "  - æ¸…ç†ç¯å¢ƒå˜é‡..."
rm -f /etc/profile.d/go.sh

# æ¸…ç†å¼€æœºè‡ªåŠ¨æ¢å¤é…ç½®
echo "  - æ¸…ç†å¼€æœºè‡ªåŠ¨æ¢å¤é…ç½®..."
# ä½¿ç”¨ç²¾ç¡®çš„æ ‡è®°å—æ¸…ç†ï¼Œé¿å…è¯¯åˆ å…¶ä»–å†…å®¹
sed -i "/^# BEGIN easy-dwgo (do not edit)$/,/^# END easy-dwgo$/d" /boot/config/go 2>/dev/null || true

# æ¸…ç†æ’ä»¶ç›®å½•
echo "  - æ¸…ç†æ’ä»¶ç›®å½•..."
rm -rf /usr/local/emhttp/plugins/easy-dwgo
rm -rf /boot/config/plugins/easy-dwgo

# æ¸…ç†å†…å­˜ä¸´æ—¶ç›®å½•
echo "  - æ¸…ç†å†…å­˜ä¸´æ—¶ç›®å½•..."
rm -rf /var/tmp/easy-dwgo-progress /tmp/go-download

# æ¸…ç†Go SDKå¤‡ä»½
echo "  - æ¸…ç†Go SDKå¤‡ä»½..."
rm -f /boot/config/plugins/easy-dwgo/go-sdk.tar.gz

# æ¸…ç†ç³»ç»Ÿè¦†ç›–å±‚æ–‡ä»¶
echo "  - æ¸…ç†ç³»ç»Ÿæ–‡ä»¶..."
rm -rf /var/local/overlay/usr/local/emhttp/plugins/easy-dwgo
rm -f /var/local/overlay/usr/local/emhttp/plugins/easy-dwgo.*

# æ¸…ç†æ—¥å¿—æ–‡ä»¶
echo "  - æ¸…ç†æ—¥å¿—æ–‡ä»¶..."
rm -f /var/log/easy-dwgo.log

echo ""
echo "ğŸ‰ Easy-Dwgo æ’ä»¶å¸è½½å®Œæˆï¼"
echo "   æ‰€æœ‰ç›¸å…³æ–‡ä»¶å’Œé…ç½®å·²å®Œå…¨æ¸…ç†ã€‚"
]]></INLINE>
</FILE>

</PLUGIN>
